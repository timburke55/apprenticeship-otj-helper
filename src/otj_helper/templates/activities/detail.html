{% extends "base.html" %}
{% block title %}{{ activity.title }}{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ activity.title }}</h1>
            <p class="mt-1 text-sm text-gray-500">
                {{ activity.activity_date.strftime('%d %B %Y') }}
                &middot; {{ "%.1f"|format(activity.duration_hours) }} hours
                &middot; {{ dict(activity.ACTIVITY_TYPES).get(activity.activity_type, activity.activity_type) }}
            </p>
        </div>
        <div class="mt-3 sm:mt-0 flex gap-2">
            <a href="{{ url_for('activities.edit', activity_id=activity.id) }}"
                class="rounded-md bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                Edit
            </a>
            <form method="post" action="{{ url_for('activities.delete', activity_id=activity.id) }}" class="inline"
                onsubmit="return confirm('Delete this activity?')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                    class="rounded-md bg-white px-3 py-2 text-sm font-medium text-red-600 shadow-sm ring-1 ring-inset ring-red-200 hover:bg-red-50">
                    Delete
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Activity Details -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
    {% if activity.description %}
    <div class="mb-5">
        <h2 class="text-sm font-medium text-gray-500 mb-2">Description</h2>
        <p class="text-sm text-gray-900 whitespace-pre-wrap">{{ activity.description }}</p>
    </div>
    {% endif %}

    <div{% if activity.description %} class="border-t border-gray-100 pt-5"{% endif %}>
        <h2 class="text-sm font-medium text-gray-500 mb-3">Attachments</h2>

        {% if activity.attachments %}
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
            {% for att in activity.attachments %}
            <div class="border rounded-lg p-2 text-center">
                {% if att.has_thumbnail %}
                <a href="{{ url_for('uploads.serve_file', attachment_id=att.id) }}" target="_blank" rel="noopener noreferrer">
                    <img src="{{ url_for('uploads.serve_thumb', attachment_id=att.id) }}"
                        class="w-full h-24 object-cover rounded" alt="{{ att.filename }}">
                </a>
                {% else %}
                <a href="{{ url_for('uploads.serve_file', attachment_id=att.id) }}" target="_blank" rel="noopener noreferrer"
                    class="block p-4 text-indigo-600 hover:text-indigo-500">
                    <span class="text-2xl">&#128196;</span>
                </a>
                {% endif %}
                <p class="text-xs text-gray-500 truncate mt-1">{{ att.filename }}</p>
                <p class="text-xs text-gray-400">{{ (att.file_size / 1024)|round(0)|int }} KB</p>
                <form method="post" action="{{ url_for('uploads.delete_attachment', attachment_id=att.id) }}"
                    class="mt-1" onsubmit="return confirm('Delete this file?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="text-xs text-red-500 hover:text-red-700">Delete</button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post" action="{{ url_for('uploads.upload', activity_id=activity.id) }}"
            enctype="multipart/form-data" class="flex items-center gap-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="file" name="files" multiple accept=".jpg,.jpeg,.png,.gif,.webp,.pdf,.doc,.docx,.txt,.md"
                class="text-sm text-gray-500">
            <button type="submit"
                class="rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-indigo-500">
                Upload
            </button>
        </form>
    </div>
</div>

<!-- CORE Workflow -->
{% set capture_links  = activity.resources | selectattr('workflow_stage', 'equalto', 'capture')  | list %}
{% set organise_links = activity.resources | selectattr('workflow_stage', 'equalto', 'organise') | list %}
{% set review_links   = activity.resources | selectattr('workflow_stage', 'equalto', 'review')   | list %}
{% set engage_links   = activity.resources | selectattr('workflow_stage', 'equalto', 'engage')   | list %}

<div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-sm font-medium text-gray-500 mb-4">CORE Workflow</h2>

    <!-- Pipeline indicator -->
    <div class="flex items-center gap-1 mb-6 overflow-x-auto">
        {% set stages = [
            ('capture',  'C', 'Capture',  capture_links,  'amber'),
            ('organise', 'O', 'Organise', organise_links, 'blue'),
            ('review',   'R', 'Review',   review_links,   'violet'),
            ('engage',   'E', 'Engage',   engage_links,   'emerald'),
        ] %}
        {% for stage_id, letter, label, links, color in stages %}
        <div class="flex items-center gap-1 flex-shrink-0">
            <div class="flex flex-col items-center">
                <span class="inline-flex items-center justify-center w-9 h-9 rounded-full text-sm font-bold
                    {% if links %}
                        {% if color == 'amber'   %}bg-amber-200   text-amber-800  {% endif %}
                        {% if color == 'blue'    %}bg-blue-200    text-blue-800   {% endif %}
                        {% if color == 'violet'  %}bg-violet-200  text-violet-800 {% endif %}
                        {% if color == 'emerald' %}bg-emerald-200 text-emerald-800{% endif %}
                    {% else %}bg-gray-100 text-gray-400{% endif %}">
                    {{ letter }}
                </span>
                <span class="text-xs mt-1
                    {% if links %}
                        {% if color == 'amber'   %}text-amber-700  {% endif %}
                        {% if color == 'blue'    %}text-blue-700   {% endif %}
                        {% if color == 'violet'  %}text-violet-700 {% endif %}
                        {% if color == 'emerald' %}text-emerald-700{% endif %}
                    {% else %}text-gray-400{% endif %}">
                    {{ label }}
                    {% if links %}<span class="font-medium">({{ links|length }})</span>{% endif %}
                </span>
            </div>
            {% if not loop.last %}
            <svg class="w-5 h-5 text-gray-300 flex-shrink-0 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Stage details -->
    <div class="space-y-4">

        {% if capture_links %}
        <div>
            <div class="flex items-center gap-2 mb-2">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-amber-200 text-amber-800 text-xs font-bold">C</span>
                <h3 class="text-sm font-semibold text-amber-900">Capture</h3>
                <span class="text-xs text-amber-600">Google Keep and initial notes</span>
            </div>
            <div class="ml-4 sm:ml-8 divide-y divide-gray-100 rounded-lg border border-amber-100 overflow-hidden">
                {% for resource in capture_links %}
                <div class="flex flex-wrap items-start justify-between gap-2 px-3 py-2 bg-amber-50/40">
                    <div class="min-w-0 flex-1">
                        <a href="{{ resource.url }}" target="_blank" rel="noopener noreferrer"
                            class="text-sm font-medium text-indigo-600 hover:text-indigo-500 break-words">{{ resource.title }}</a>
                        {% if resource.description %}
                        <p class="text-xs text-gray-500">{{ resource.description }}</p>
                        {% endif %}
                    </div>
                    <span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-700 flex-shrink-0">
                        {{ dict(resource.SOURCE_TYPES).get(resource.source_type, resource.source_type) }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if organise_links %}
        <div>
            <div class="flex items-center gap-2 mb-2">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-200 text-blue-800 text-xs font-bold">O</span>
                <h3 class="text-sm font-semibold text-blue-900">Organise</h3>
                <span class="text-xs text-blue-600">Google Tasks and structured planning</span>
            </div>
            <div class="ml-4 sm:ml-8 divide-y divide-gray-100 rounded-lg border border-blue-100 overflow-hidden">
                {% for resource in organise_links %}
                <div class="flex flex-wrap items-start justify-between gap-2 px-3 py-2 bg-blue-50/40">
                    <div class="min-w-0 flex-1">
                        <a href="{{ resource.url }}" target="_blank" rel="noopener noreferrer"
                            class="text-sm font-medium text-indigo-600 hover:text-indigo-500 break-words">{{ resource.title }}</a>
                        {% if resource.description %}
                        <p class="text-xs text-gray-500">{{ resource.description }}</p>
                        {% endif %}
                    </div>
                    <span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 flex-shrink-0">
                        {{ dict(resource.SOURCE_TYPES).get(resource.source_type, resource.source_type) }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if review_links %}
        <div>
            <div class="flex items-center gap-2 mb-2">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-violet-200 text-violet-800 text-xs font-bold">R</span>
                <h3 class="text-sm font-semibold text-violet-900">Review</h3>
                <span class="text-xs text-violet-600">Documents, diagrams, and markdown</span>
            </div>
            <div class="ml-4 sm:ml-8 divide-y divide-gray-100 rounded-lg border border-violet-100 overflow-hidden">
                {% for resource in review_links %}
                <div class="flex flex-wrap items-start justify-between gap-2 px-3 py-2 bg-violet-50/40">
                    <div class="min-w-0 flex-1">
                        <a href="{{ resource.url }}" target="_blank" rel="noopener noreferrer"
                            class="text-sm font-medium text-indigo-600 hover:text-indigo-500 break-words">{{ resource.title }}</a>
                        {% if resource.description %}
                        <p class="text-xs text-gray-500">{{ resource.description }}</p>
                        {% endif %}
                    </div>
                    <span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium bg-violet-100 text-violet-700 flex-shrink-0">
                        {{ dict(resource.SOURCE_TYPES).get(resource.source_type, resource.source_type) }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if engage_links %}
        <div>
            <div class="flex items-center gap-2 mb-2">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-emerald-200 text-emerald-800 text-xs font-bold">E</span>
                <h3 class="text-sm font-semibold text-emerald-900">Engage</h3>
                <span class="text-xs text-emerald-600">Final outputs and evidence</span>
            </div>
            <div class="ml-4 sm:ml-8 divide-y divide-gray-100 rounded-lg border border-emerald-100 overflow-hidden">
                {% for resource in engage_links %}
                <div class="flex flex-wrap items-start justify-between gap-2 px-3 py-2 bg-emerald-50/40">
                    <div class="min-w-0 flex-1">
                        <a href="{{ resource.url }}" target="_blank" rel="noopener noreferrer"
                            class="text-sm font-medium text-indigo-600 hover:text-indigo-500 break-words">{{ resource.title }}</a>
                        {% if resource.description %}
                        <p class="text-xs text-gray-500">{{ resource.description }}</p>
                        {% endif %}
                    </div>
                    <span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium bg-emerald-100 text-emerald-700 flex-shrink-0">
                        {{ dict(resource.SOURCE_TYPES).get(resource.source_type, resource.source_type) }}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if not activity.resources %}
        <p class="text-sm text-gray-400 text-center py-2">No workflow links added yet. <a href="{{ url_for('activities.edit', activity_id=activity.id) }}" class="text-indigo-600 hover:text-indigo-500">Edit</a> to add them.</p>
        {% endif %}

    </div>
</div>

{% if activity.ksbs %}
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-sm font-medium text-gray-500 mb-3">KSBs Covered</h2>
    <div class="space-y-2">
        {% for ksb in activity.ksbs|sort(attribute='code') %}
        <a href="{{ url_for('ksbs.detail', code=ksb.code) }}" class="block p-2 rounded-md hover:bg-gray-50">
            <span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium mr-2
                {% if ksb.category == 'knowledge' %}bg-knowledge-light text-knowledge-dark
                {% elif ksb.category == 'skill' %}bg-skill-light text-skill-dark
                {% else %}bg-behaviour-light text-behaviour-dark{% endif %}">
                {{ ksb.natural_code }}
            </span>
            <span class="text-sm text-gray-900">{{ ksb.title }}</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if activity.tags %}
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-sm font-medium text-gray-500 mb-3">Tags</h2>
    <div class="flex flex-wrap gap-2">
        {% for tag in activity.tags|sort(attribute='name') %}
        <a href="{{ url_for('activities.list_activities', tag=tag.id) }}"
            class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-indigo-50 text-indigo-700 hover:bg-indigo-100">
            {{ tag.name }}
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if activity.notes %}
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-sm font-medium text-gray-500 mb-2">Notes</h2>
    <p class="text-sm text-gray-900 whitespace-pre-wrap">{{ activity.notes }}</p>
</div>
{% endif %}

<div class="text-sm text-gray-400">
    Created {{ activity.created_at.strftime('%d %b %Y %H:%M') }}
    {% if activity.updated_at and activity.updated_at != activity.created_at %}
    &middot; Updated {{ activity.updated_at.strftime('%d %b %Y %H:%M') }}
    {% endif %}
</div>
{% endblock %}
