{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"
        integrity="sha384-vsrfeLOOY6KuIYKDlmVH5UiBmgIdB1oEf7p01YgWHuqmOHfZr374+odEv96n9tNC"
        crossorigin="anonymous"></script>

<div class="mb-8">
    <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">OTJ Training Dashboard</h1>
        <span id="sse-status" class="inline-flex h-2 w-2 rounded-full bg-gray-300" title="Real-time updates"></span>
    </div>
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{% if current_spec %}{{ current_spec.name }} L{{ current_spec.level }}{% endif %} — Off-the-Job Training Tracker</p>
</div>

<!-- Portfolio Readiness widget -->
<div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-8">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div class="flex items-center gap-4">
            <!-- Mini circular score -->
            {% set score = overall_score|int %}
            {% if score >= 75 %}
                {% set ring_cls = "stroke-emerald-500" %}
                {% set text_cls = "text-emerald-600 dark:text-emerald-400" %}
            {% elif score >= 50 %}
                {% set ring_cls = "stroke-amber-500" %}
                {% set text_cls = "text-amber-600 dark:text-amber-400" %}
            {% else %}
                {% set ring_cls = "stroke-red-500" %}
                {% set text_cls = "text-red-600 dark:text-red-400" %}
            {% endif %}
            <div class="relative flex-shrink-0" style="width:64px;height:64px;">
                <svg class="w-full h-full -rotate-90" viewBox="0 0 64 64">
                    <circle cx="32" cy="32" r="26" fill="none" stroke-width="6"
                        class="stroke-gray-200 dark:stroke-gray-700"/>
                    <circle cx="32" cy="32" r="26" fill="none" stroke-width="6"
                        stroke-linecap="round"
                        stroke-dasharray="{{ 2 * 3.14159 * 26 }}"
                        stroke-dashoffset="{{ (2 * 3.14159 * 26) * (1 - score / 100) }}"
                        class="{{ ring_cls }}"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-sm font-bold {{ text_cls }}">{{ score }}%</span>
                </div>
            </div>
            <div>
                <h2 class="text-base font-semibold text-gray-900 dark:text-white">Portfolio Readiness</h2>
                {% if top_suggestions %}
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">{{ top_suggestions[0] }}</p>
                {% else %}
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">No gaps detected — great work!</p>
                {% endif %}
            </div>
        </div>
        <a href="{{ url_for('recommendations.index') }}"
            class="flex-shrink-0 text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 dark:hover:text-indigo-300">
            View all recommendations &rarr;
        </a>
    </div>
</div>

<!-- Summary cards -->
<div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
    <div class="overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 py-5 shadow sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500 dark:text-gray-400">Total OTJ Hours</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900 dark:text-white">{{ "%.1f"|format(total_hours) }}</dd>
        {% if otj_target_hours is not none and otj_target_hours > 0 %}
        <div class="mt-2">
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                <span>Target: {{ "%.0f"|format(otj_target_hours) }}h</span>
                <span>{{ "%.0f"|format([total_hours / otj_target_hours * 100, 100]|min) }}%</span>
            </div>
            <div class="bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                <div class="bg-indigo-600 rounded-full h-1.5" style="width: {{ [total_hours / otj_target_hours * 100, 100]|min }}%"></div>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 py-5 shadow sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500 dark:text-gray-400">This Week</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900 dark:text-white">{{ "%.1f"|format(this_week_hours) }}h</dd>
        {% if weekly_target_hours is not none and weekly_target_hours > 0 %}
        <div class="mt-2">
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                <span>Target: {{ "%.1f"|format(weekly_target_hours) }}h</span>
                {% set remaining = weekly_target_hours - this_week_hours %}
                {% if remaining > 0 %}
                <span class="text-amber-600 dark:text-amber-400">{{ "%.1f"|format(remaining) }}h remaining</span>
                {% else %}
                <span class="text-emerald-600 dark:text-emerald-400">Target met</span>
                {% endif %}
            </div>
            <div class="bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
                <div class="rounded-full h-1.5 {% if this_week_hours >= weekly_target_hours %}bg-emerald-500{% else %}bg-amber-500{% endif %}"
                    style="width: {{ [this_week_hours / weekly_target_hours * 100, 100]|min }}%"></div>
            </div>
        </div>
        {% else %}
        <p class="mt-1 text-xs text-gray-400 dark:text-gray-500">Set a weekly target below</p>
        {% endif %}
    </div>
    <div class="overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 py-5 shadow sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500 dark:text-gray-400">Activities Logged</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900 dark:text-white">{{ activity_count }}</dd>
    </div>
    <div class="overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 py-5 shadow sm:p-6">
        <dt class="truncate text-sm font-medium text-gray-500 dark:text-gray-400">KSBs Covered</dt>
        <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900 dark:text-white">{{ ksb_coverage|selectattr('4', 'greaterthan', 0)|list|length }} / {{ ksb_coverage|length }}</dd>
    </div>
</div>

<!-- Weekly hours chart -->
<div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-8">
    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Hours per Week (last 12 weeks)</h2>
    <div style="position: relative; height: 200px;">
        <canvas id="weeklyChart"></canvas>
    </div>
</div>

<!-- OTJ target & seminar time -->
<div class="grid grid-cols-1 gap-6 sm:grid-cols-2 mb-8">

    <!-- Seminar vs total OTJ -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Seminar &amp; Structured Learning</h2>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Counts Training Course and Workshop activities as seminar time.</p>
        <div style="position: relative; height: 200px;">
            <canvas id="seminarChart"></canvas>
        </div>
        {% if seminar_target_hours is not none and seminar_target_hours > 0 %}
        <div class="mt-4">
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                <span>Seminar target: {{ "%.0f"|format(seminar_target_hours) }}h</span>
                <span>{{ "%.0f"|format([seminar_hours / seminar_target_hours * 100, 100]|min) }}%</span>
            </div>
            <div class="bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                <div class="bg-emerald-500 rounded-full h-2" style="width: {{ [seminar_hours / seminar_target_hours * 100, 100]|min }}%"></div>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ "%.1f"|format(seminar_hours) }}h logged of {{ "%.0f"|format(seminar_target_hours) }}h target</p>
        </div>
        {% endif %}
    </div>

    <!-- Hours targets settings -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-1">Hours Targets</h2>
        <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Set your total OTJ and seminar hour targets for the apprenticeship.</p>
        <form method="POST" action="{{ url_for('dashboard.index') }}" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div>
                <label for="otj_target_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Total OTJ target (hours)</label>
                <input type="number" id="otj_target_hours" name="otj_target_hours" min="0" step="0.5"
                    value="{{ "%.1f"|format(otj_target_hours) if otj_target_hours is not none else '' }}"
                    placeholder="e.g. 460"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400">
                <p class="mt-1 text-xs text-gray-400 dark:text-gray-500">Typically 20% of total contracted hours (e.g. 37.5h/wk × 24 months ≈ 390–460h)</p>
            </div>
            <div>
                <label for="seminar_target_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Seminar time target (hours)</label>
                <input type="number" id="seminar_target_hours" name="seminar_target_hours" min="0" step="0.5"
                    value="{{ "%.1f"|format(seminar_target_hours) if seminar_target_hours is not none else '' }}"
                    placeholder="e.g. 120"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400">
                <p class="mt-1 text-xs text-gray-400 dark:text-gray-500">Expected hours from Training Course &amp; Workshop activities with your provider</p>
            </div>
            <div>
                <label for="weekly_target_hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Weekly OTJ target (hours)</label>
                <input type="number" id="weekly_target_hours" name="weekly_target_hours" min="0" step="0.5"
                    value="{{ "%.1f"|format(weekly_target_hours) if weekly_target_hours is not none else '' }}"
                    placeholder="e.g. 7.5"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm border px-3 py-2 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400">
                <p class="mt-1 text-xs text-gray-400 dark:text-gray-500">Target OTJ hours per week — shows remaining hours on the dashboard</p>
            </div>
            <button type="submit"
                class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none">
                Save targets
            </button>
        </form>
    </div>
</div>

<!-- KSB Coverage chart -->
<div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-8">
    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-1">KSB Progress</h2>
    <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Hours logged per KSB. Grey bars have no evidence yet — focus here.</p>
    {% set k_items = ksb_coverage|selectattr('1', 'equalto', 'knowledge')|list %}
    {% set s_items = ksb_coverage|selectattr('1', 'equalto', 'skill')|list %}
    {% set b_items = ksb_coverage|selectattr('1', 'equalto', 'behaviour')|list %}

    <!-- Knowledge -->
    {% if k_items %}
    <h3 class="text-sm font-semibold text-knowledge-dark mb-2 mt-4">Knowledge</h3>
    <div style="position: relative; height: {{ k_items|length * 28 + 10 }}px;">
        <canvas id="ksbChartK"></canvas>
    </div>
    {% endif %}

    <!-- Skills -->
    {% if s_items %}
    <h3 class="text-sm font-semibold text-skill-dark mb-2 mt-6">Skills</h3>
    <div style="position: relative; height: {{ s_items|length * 28 + 10 }}px;">
        <canvas id="ksbChartS"></canvas>
    </div>
    {% endif %}

    <!-- Behaviours -->
    {% if b_items %}
    <h3 class="text-sm font-semibold text-behaviour-dark mb-2 mt-6">Behaviours</h3>
    <div style="position: relative; height: {{ b_items|length * 28 + 10 }}px;">
        <canvas id="ksbChartB"></canvas>
    </div>
    {% endif %}
</div>

<!-- KSB Coverage pill grid (quick overview) -->
<div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-8">
    <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">KSB Coverage Map</h2>
    <div class="space-y-4">
        <div>
            <h3 class="text-sm font-semibold text-knowledge-dark mb-2">Knowledge</h3>
            <div class="flex flex-wrap gap-2">
                {% for code, category, title, count, hours in ksb_coverage if category == 'knowledge' %}
                <a href="{{ url_for('ksbs.detail', code=code) }}" class="inline-flex items-center rounded-md px-3 py-1.5 text-sm font-medium
                    {% if count > 0 %}bg-knowledge-light text-knowledge-dark{% else %}bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500{% endif %}
                    hover:ring-2 hover:ring-knowledge">
                    {{ natural_code(code) }}
                    {% if count > 0 %}<span class="ml-1.5 text-xs">({{ "%.1f"|format(hours) }}h)</span>{% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
        <div>
            <h3 class="text-sm font-semibold text-skill-dark mb-2">Skills</h3>
            <div class="flex flex-wrap gap-2">
                {% for code, category, title, count, hours in ksb_coverage if category == 'skill' %}
                <a href="{{ url_for('ksbs.detail', code=code) }}" class="inline-flex items-center rounded-md px-3 py-1.5 text-sm font-medium
                    {% if count > 0 %}bg-skill-light text-skill-dark{% else %}bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500{% endif %}
                    hover:ring-2 hover:ring-skill">
                    {{ natural_code(code) }}
                    {% if count > 0 %}<span class="ml-1.5 text-xs">({{ "%.1f"|format(hours) }}h)</span>{% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
        <div>
            <h3 class="text-sm font-semibold text-behaviour-dark mb-2">Behaviours</h3>
            <div class="flex flex-wrap gap-2">
                {% for code, category, title, count, hours in ksb_coverage if category == 'behaviour' %}
                <a href="{{ url_for('ksbs.detail', code=code) }}" class="inline-flex items-center rounded-md px-3 py-1.5 text-sm font-medium
                    {% if count > 0 %}bg-behaviour-light text-behaviour-dark{% else %}bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500{% endif %}
                    hover:ring-2 hover:ring-behaviour">
                    {{ natural_code(code) }}
                    {% if count > 0 %}<span class="ml-1.5 text-xs">({{ "%.1f"|format(hours) }}h)</span>{% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Tag cloud -->
{% if top_tags %}
<div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-900 dark:text-white">Tags</h2>
        <a href="{{ url_for('tags.list_tags') }}" class="text-sm text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300">Manage tags</a>
    </div>
    <div class="flex flex-wrap gap-2">
        {% for tag, count in top_tags %}
        <a href="{{ url_for('activities.list_activities', tag=tag.id) }}"
            class="inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-sm font-medium bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-100 dark:hover:bg-indigo-900/50">
            {{ tag.name }}
            <span class="text-xs text-indigo-400 dark:text-indigo-500">{{ count }}</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recent activities -->
<div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-900 dark:text-white">Recent Activities</h2>
        <a href="{{ url_for('activities.list_activities') }}" class="text-sm text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300">View all</a>
    </div>
    {% if recent %}
    <div class="divide-y divide-gray-100 dark:divide-gray-700">
        {% for activity in recent %}
        <div class="py-3">
            <div class="flex justify-between items-start">
                <div>
                    <a href="{{ url_for('activities.detail', activity_id=activity.id) }}" class="text-sm font-medium text-gray-900 dark:text-white hover:text-indigo-600 dark:hover:text-indigo-400">{{ activity.title }}</a>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">{{ activity.activity_date.strftime('%d %b %Y') }} &middot; {{ "%.1f"|format(activity.duration_hours) }}h</p>
                </div>
                <div class="flex gap-1">
                    {% for ksb in activity.ksbs %}
                    <span class="inline-flex items-center rounded px-1.5 py-0.5 text-xs font-medium
                        {% if ksb.category == 'knowledge' %}bg-knowledge-light text-knowledge-dark
                        {% elif ksb.category == 'skill' %}bg-skill-light text-skill-dark
                        {% else %}bg-behaviour-light text-behaviour-dark{% endif %}">
                        {{ ksb.natural_code }}
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-sm text-gray-500 dark:text-gray-400 py-4 text-center">No activities logged yet. <a href="{{ url_for('activities.create') }}" class="text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300">Log your first activity</a>.</p>
    {% endif %}
</div>

<script>
(function () {
    function computeColors() {
        var dark = document.documentElement.classList.contains('dark');
        return {
            tick: dark ? '#9ca3af' : '#6b7280',
            grid: dark ? '#374151' : '#e5e7eb',
            zero: dark ? 'rgba(75, 85, 99, 0.8)' : 'rgba(209, 213, 219, 0.8)',
        };
    }
    var colors = computeColors();
    var chartInstances = [];

    // ── Weekly hours bar chart ──────────────────────────────────────────────
    const weeklyData = {{ weekly_chart_data|tojson }};
    chartInstances.push(new Chart(document.getElementById('weeklyChart'), {
        type: 'bar',
        data: {
            labels: weeklyData.labels,
            datasets: [{
                label: 'OTJ Hours',
                data: weeklyData.values,
                backgroundColor: 'rgba(99, 102, 241, 0.7)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 1,
                borderRadius: 3,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => ctx.parsed.y.toFixed(1) + 'h'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: v => v + 'h', color: colors.tick },
                    grid: { color: colors.grid }
                },
                x: {
                    ticks: { color: colors.tick },
                    grid: { color: colors.grid }
                }
            }
        }
    }));

    // ── Seminar vs other OTJ doughnut ────────────────────────────────────────
    const seminarHours = {{ seminar_hours|float }};
    const totalHours   = {{ total_hours|float }};
    const otherHours   = Math.max(0, totalHours - seminarHours);
    chartInstances.push(new Chart(document.getElementById('seminarChart'), {
        type: 'doughnut',
        data: {
            labels: totalHours > 0 ? ['Seminar / Structured', 'Other OTJ'] : ['No activities yet'],
            datasets: [{
                data: totalHours > 0 ? [seminarHours, otherHours] : [1],
                backgroundColor: totalHours > 0
                    ? ['rgba(16, 185, 129, 0.75)', 'rgba(99, 102, 241, 0.5)']
                    : ['rgba(229, 231, 235, 1)'],
                borderColor: totalHours > 0
                    ? ['rgba(16, 185, 129, 1)', 'rgba(99, 102, 241, 1)']
                    : ['rgba(209, 213, 219, 1)'],
                borderWidth: 1,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, color: colors.tick } },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            if (totalHours === 0) return 'No activities yet';
                            return ctx.label + ': ' + ctx.parsed.toFixed(1) + 'h';
                        }
                    }
                }
            }
        }
    }));

    // ── KSB progress horizontal bar charts ───────────────────────────────────
    function makeKsbChart(canvasId, items, color, zeroColor) {
        const el = document.getElementById(canvasId);
        if (!el || items.length === 0) return null;
        const labels = items.map(i => i.code);
        const hours  = items.map(i => i.hours);
        const bgColors = hours.map(h => h > 0 ? color : zeroColor);
        return new Chart(el, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    data: hours.map(h => h > 0 ? h : 0.05),   // tiny stub so zero items are visible
                    backgroundColor: bgColors,
                    borderColor: bgColors,
                    borderWidth: 0,
                    borderRadius: 3,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const h = items[ctx.dataIndex].hours;
                                return h > 0 ? h.toFixed(1) + 'h' : 'No evidence yet';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { callback: v => v + 'h', color: colors.tick },
                        grid: { color: colors.grid }
                    },
                    y: { ticks: { font: { size: 11 }, color: colors.tick }, grid: { color: colors.grid } }
                }
            }
        });
    }

    {% set k_items = ksb_coverage|selectattr('1', 'equalto', 'knowledge')|list %}
    {% set s_items = ksb_coverage|selectattr('1', 'equalto', 'skill')|list %}
    {% set b_items = ksb_coverage|selectattr('1', 'equalto', 'behaviour')|list %}

    [
        makeKsbChart('ksbChartK',
            [{% for code, cat, title, count, hours in k_items %}{code: {{ natural_code(code)|tojson }}, hours:{{ hours|float }}},{% endfor %}],
            'rgba(59, 130, 246, 0.75)', colors.zero
        ),
        makeKsbChart('ksbChartS',
            [{% for code, cat, title, count, hours in s_items %}{code: {{ natural_code(code)|tojson }}, hours:{{ hours|float }}},{% endfor %}],
            'rgba(34, 197, 94, 0.75)', colors.zero
        ),
        makeKsbChart('ksbChartB',
            [{% for code, cat, title, count, hours in b_items %}{code: {{ natural_code(code)|tojson }}, hours:{{ hours|float }}},{% endfor %}],
            'rgba(245, 158, 11, 0.75)', colors.zero
        ),
    ].filter(Boolean).forEach(function (c) { chartInstances.push(c); });

    function updateChartColors() {
        var c = computeColors();
        chartInstances.forEach(function (chart) {
            var scales = chart.options.scales || {};
            ['x', 'y'].forEach(function (axis) {
                if (scales[axis]) {
                    if (scales[axis].ticks) scales[axis].ticks.color = c.tick;
                    if (scales[axis].grid) scales[axis].grid.color = c.grid;
                }
            });
            if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                chart.options.plugins.legend.labels.color = c.tick;
            }
            chart.update('none');
        });
    }

    new MutationObserver(function () { updateChartColors(); })
        .observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
})();

// Real-time updates via SSE
(function () {
    if (typeof EventSource === 'undefined') return;

    const evtSource = new EventSource({{ url_for('events.stream')|tojson }});

    evtSource.addEventListener('activity_saved', function (e) {
        showUpdateBanner('Activity updated — refreshing...');
        setTimeout(function () { window.location.reload(); }, 1500);
    });

    evtSource.addEventListener('activity_deleted', function (e) {
        showUpdateBanner('Activity deleted — refreshing...');
        setTimeout(function () { window.location.reload(); }, 1500);
    });

    evtSource.onerror = function () {
        var dot = document.getElementById('sse-status');
        if (dot) {
            dot.className = 'inline-flex h-2 w-2 rounded-full bg-red-400';
            dot.title = 'Disconnected — reconnecting...';
        }
    };

    evtSource.onopen = function () {
        var dot = document.getElementById('sse-status');
        if (dot) {
            dot.className = 'inline-flex h-2 w-2 rounded-full bg-green-400';
            dot.title = 'Connected — real-time updates active';
        }
    };

    function showUpdateBanner(text) {
        var existing = document.getElementById('sse-banner');
        if (existing) existing.remove();
        var banner = document.createElement('div');
        banner.id = 'sse-banner';
        banner.className = 'mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-2';
        banner.innerHTML = '<div class="rounded-md p-3 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 text-sm font-medium">' + text + '</div>';
        document.querySelector('main').prepend(banner);
    }
})();
</script>
{% endblock %}
